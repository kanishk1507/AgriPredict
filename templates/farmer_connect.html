{% extends "base.html" %}

{% block title %}Farmer Connect - Community Platform{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section" style="min-height: 60vh;">
    <div class="hero-overlay"></div>
    <div class="container">
        <div class="row align-items-center h-100">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="hero-title">Farmer Connect</h1>
                <p class="hero-description">
                    Join thousands of farmers sharing knowledge, experiences, and growing together
                </p>
                <div class="hero-buttons">
                    <a href="#community-features" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-users me-2"></i>Join Community
                    </a>
                    <a href="#ask-question" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-question-circle me-2"></i>Ask Question
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Quick Stats -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-item">
                    <h3 class="text-success mb-1">25,000+</h3>
                    <small class="text-muted">Active Farmers</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-item">
                    <h3 class="text-primary mb-1">15,000+</h3>
                    <small class="text-muted">Questions Answered</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-item">
                    <h3 class="text-warning mb-1">500+</h3>
                    <small class="text-muted">Expert Advisors</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stat-item">
                    <h3 class="text-info mb-1">50+</h3>
                    <small class="text-muted">States Covered</small>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Community Features -->
<section id="community-features" class="py-5">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-lg-8 mx-auto">
                <h2 class="text-plant-primary">Community Features</h2>
                <p class="text-muted">Connect, learn, and grow with fellow farmers</p>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="feature-card text-center h-100">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-comments text-primary"></i>
                    </div>
                    <h5>Discussion Forum</h5>
                    <p>Ask questions, share experiences, and get advice from experienced farmers.</p>
                    <a href="{{ url_for('farmer_forum') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-right me-1"></i>Join Discussion
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="feature-card text-center h-100">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-user-graduate text-success"></i>
                    </div>
                    <h5>Expert Advice</h5>
                    <p>Get professional guidance from agricultural experts and extension officers.</p>
                    <a href="{{ url_for('expert_advice') }}" class="btn btn-outline-success">
                        <i class="fas fa-arrow-right me-1"></i>Consult Expert
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="feature-card text-center h-100">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-handshake text-warning"></i>
                    </div>
                    <h5>Local Connections</h5>
                    <p>Connect with farmers in your area for knowledge sharing and collaboration.</p>
                    <a href="#connect-farmers" class="btn btn-outline-warning">
                        <i class="fas fa-arrow-right me-1"></i>Find Farmers
                    </a>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="feature-card text-center h-100">
                    <div class="feature-icon mb-3">
                        <i class="fas fa-store text-info"></i>
                    </div>
                    <h5>Marketplace</h5>
                    <p>Buy and sell farming equipment, seeds, and produce directly with other farmers.</p>
                    <a href="{{ url_for('farmer_marketplace') }}" class="btn btn-outline-info">
                        <i class="fas fa-arrow-right me-1"></i>Visit Market
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Ask Question Section -->
<section id="ask-question" class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow">
                    <div class="card-header bg-success text-white text-center">
                        <h4 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>Ask the Community
                        </h4>
                        <p class="mb-0 mt-2">Get answers from experienced farmers and experts</p>
                    </div>
                    <div class="card-body p-4">
                        <form id="question-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="farmer_name" class="form-label">Your Name *</label>
                                    <input type="text" class="form-control" id="farmer_name" name="farmer_name" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="location" class="form-label">Location *</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           placeholder="e.g., Pune, Maharashtra" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="crop_type" class="form-label">Related Crop</label>
                                    <select class="form-select" id="crop_type" name="crop_type">
                                        <option value="General">General Farming</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Maize">Maize</option>
                                        <option value="Cotton">Cotton</option>
                                        <option value="Sugarcane">Sugarcane</option>
                                        <option value="Vegetables">Vegetables</option>
                                        <option value="Fruits">Fruits</option>
                                        <option value="Pulses">Pulses</option>
                                        <option value="Oilseeds">Oilseeds</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="category" class="form-label">Question Category *</label>
                                    <select class="form-select" id="category" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="Disease Management">Disease Management</option>
                                        <option value="Pest Control">Pest Control</option>
                                        <option value="Fertilizer & Nutrition">Fertilizer & Nutrition</option>
                                        <option value="Soil Management">Soil Management</option>
                                        <option value="Water Management">Water Management</option>
                                        <option value="Market Information">Market Information</option>
                                        <option value="Technology & Equipment">Technology & Equipment</option>
                                        <option value="Government Schemes">Government Schemes</option>
                                        <option value="General Advice">General Advice</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="question" class="form-label">Your Question *</label>
                                <textarea class="form-control" id="question" name="question" rows="4" 
                                          placeholder="Describe your problem or question in detail..." required></textarea>
                                <small class="text-muted">Be specific about symptoms, timing, and what you've already tried.</small>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    <i class="fas fa-paper-plane me-2"></i>Post Question
                                </button>
                            </div>
                        </form>
                        
                        <div id="question-result" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Connect with Local Farmers -->
<section id="connect-farmers" class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card border-0 shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h4 class="mb-0">
                            <i class="fas fa-users me-2"></i>Connect with Local Farmers
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="farmer-connect-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="connect_location" class="form-label">Your Location *</label>
                                    <input type="text" class="form-control" id="connect_location" name="location" 
                                           placeholder="City, State" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="crop_interest" class="form-label">Crop Interest</label>
                                    <select class="form-select" id="crop_interest" name="crop_interest">
                                        <option value="All">All Crops</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Cotton">Cotton</option>
                                        <option value="Vegetables">Vegetables</option>
                                        <option value="Fruits">Fruits</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Find Farmers Nearby
                                </button>
                            </div>
                        </form>
                        
                        <div id="farmers-result" class="mt-4" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Recent Forum Activity -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center mb-4">
                <h3 class="text-plant-primary">Recent Community Activity</h3>
                <p class="text-muted">See what farmers are discussing</p>
            </div>
        </div>
        
        <div id="recent-posts">
            <!-- Posts will be loaded here via JavaScript -->
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('farmer_forum') }}" class="btn btn-success btn-lg">
                <i class="fas fa-comments me-2"></i>View All Discussions
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Load recent forum posts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRecentPosts();
    initializeFarmerConnectForms();
});

function loadRecentPosts() {
    fetch('/api/get-forum-posts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRecentPosts(data.posts.slice(0, 3));
            }
        })
        .catch(error => console.error('Error loading posts:', error));
}

function displayRecentPosts(posts) {
    const container = document.getElementById('recent-posts');
    let html = '<div class="row">';
    
    posts.forEach(post => {
        const statusBadge = post.status === 'answered' ? 'success' : 'warning';
        html += `
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${post.question.substring(0, 60)}...</h6>
                        <p class="small text-muted mb-2">
                            <i class="fas fa-user me-1"></i>${post.farmer_name} • 
                            <i class="fas fa-map-marker-alt me-1"></i>${post.location}
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-${statusBadge}">${post.status}</span>
                            <small class="text-muted">${post.responses} responses</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function initializeFarmerConnectForms() {
    // Question form handler
    const questionForm = document.getElementById('question-form');
    if (questionForm) {
        questionForm.addEventListener('submit', handleQuestionSubmit);
    }
    
    // Farmer connect form handler
    const farmerConnectForm = document.getElementById('farmer-connect-form');
    if (farmerConnectForm) {
        farmerConnectForm.addEventListener('submit', handleFarmerConnect);
    }
}

async function handleQuestionSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        farmer_name: formData.get('farmer_name'),
        location: formData.get('location'),
        crop_type: formData.get('crop_type'),
        category: formData.get('category'),
        question: formData.get('question')
    };
    
    try {
        const response = await fetch('/api/post-question', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('question-result').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${result.message}<br>
                    <small>Question ID: ${result.question_id} • Expected response time: ${result.estimated_response_time}</small>
                </div>
            `;
            document.getElementById('question-result').style.display = 'block';
            e.target.reset();
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        document.getElementById('question-result').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error posting question: ${error.message}
            </div>
        `;
        document.getElementById('question-result').style.display = 'block';
    }
}

async function handleFarmerConnect(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        location: formData.get('location'),
        crop_interest: formData.get('crop_interest')
    };
    
    try {
        const response = await fetch('/api/connect-farmers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayNearbyFarmers(result.farmers);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        document.getElementById('farmers-result').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error finding farmers: ${error.message}
            </div>
        `;
        document.getElementById('farmers-result').style.display = 'block';
    }
}

function displayNearbyFarmers(farmers) {
    const container = document.getElementById('farmers-result');
    
    let html = `
        <h5><i class="fas fa-users me-2"></i>Farmers Near You</h5>
        <div class="row">
    `;
    
    farmers.forEach(farmer => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">${farmer.name}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>${farmer.distance}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning">${farmer.rating} ⭐</span>
                            </div>
                        </div>
                        <p class="small mt-2 mb-1">
                            <strong>Crops:</strong> ${farmer.crops.join(', ')}
                        </p>
                        <p class="small mb-1">
                            <strong>Experience:</strong> ${farmer.experience}
                        </p>
                        <p class="small mb-1">
                            <strong>Specialization:</strong> ${farmer.specialization}
                        </p>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="connectFarmer('${farmer.name}', '${farmer.contact}')">
                                <i class="fas fa-phone me-1"></i>Connect
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    container.style.display = 'block';
}

function connectFarmer(name, contact) {
    alert(`Contact ${name} at ${contact}`);
}
</script>
{% endblock %}
